<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/home.css">
    <title>Weekend Discharge </title>
</head>
<body>
    <header>
        <div class="header-container">
          <h1>PatientPathway</h1>
         <a href="/"><button class="back-home">Home</button></a>
        </div>
      </header>
   <main class="container">
    <div id="message-banner" class="hidden">
    </div>
    <h2 id="page-header">Weekend Discharge Request</h2>  

    <form id="patient-discharge-requestor-form" class="form-information">
     <div class="request-container">
        <div class="request-info">
            <div class="discharge-input">
        <p id ="discharge-text">Name</p>
        <input type="text" id ="discharge-input-text" name="dischargeRequestedBy" >
    </div>
    <div class="discharge-input">
        <p id = "discharge-text">Extension</p>
        <input type="text" id ="discharge-input-text"  name="dischargeExtensionNumber" >
    </div>
    <div class="discharge-input">
        <p id ="discharge-text">Department</p>
        <input type="text" id ="discharge-input-text"  name="dischargeDeparment" >
    </div>
    </div>
    <div class="request-hospital">
    <p id="hospital-header">Hospital/Medical Office</p>
    <div class="hospital-options">
    <div class="hospital-input">
    <label for="PHWH">PHWH</label>
    <input type="radio" id="hospital-radio-options" name="dischargeHospital" value="PHWH">
</div>
<div class="hospital-input">
    <label for="PHDH">PHDH</label>
    <input type="radio" id="hospital-radio-options" name="dischargeHospital" value="PHDH">
</div>
<div class="hospital-input">

    <label for="PHGSH">PHGSH</label>
    <input type ="radio" id="hospital-radio-options" name="dischargeHospital" value="PHGSH">
</div>
<div class="hospital-input">

    <label for="PHP">PHP</label>
    <input type="radio" id="hospital-radio-options" name="dischargeHospital" value="PHP">
</div>
    </div>
</form>
    </div>
</div>
<form id ="patient-information-form" class="form-information">
    <h3 id="page-header">Patient Information</h3>  
    <div class="patient-information">
        <div class="patient-information-left">
            <div class="patient-information-input">
        <p id ="patient-information-text">First Name</p>
        <input type="text" id ="patient-input-text"  name="patientFirstName" placeholder="John" required>
    </div>

        <div class="patient-information-input">
        <p id ="patient-information-text">Last Name</p>
        <input type="text"  id ="patient-input-text"  name="patientLastName" placeholder="Doe" required>
    </div>

        <div class="patient-information-input">
        <p id ="patient-information-text">Phone Number</p>
        <input type="text"  id ="patient-input-text"  name="patientPhoneNumber" placeholder="(123) 456-7890">
    </div>

        <div class="patient-information-input">
        <p id ="patient-information-text">Medical Record #</p>
        <input type="text" id ="patient-input-text"   name="patientMRN" placeholder="0123456" required>
    </div>

        <div class="patient-information-input">
        <p id ="patient-information-text">Date of Birth</p>
        <input type="date" id ="patient-input-text"   name="patientDoB" placeholder="12/25/1980" >
    </div>

    </div>
    <div class="patient-information-right">
        <div class="patient-information-input">
        <p id ="patient-information-text">Height</p>
        <input type="text" id ="patient-input-text" name="patientHeight" placeholder="70in">
    </div>
    <div class="patient-information-input">
        <p id ="patient-information-text">Weight</p>
        <input type="number" id ="patient-input-text"  name="patientWeight" placeholder="185lbs">
    </div>
    <div class="patient-information-input">
        <p id ="patient-information-text">Gender</p>
        <input type="text"id ="patient-input-text"  name="patientGender" placeholder="Female/Male">
    </div>
    <div class="patient-information-input">
        <p id ="patient-information-text">Primary Language</p>
        <input type="text" id ="patient-input-text"  name="patientLanguage" placeholder="English">
    </div>
    <div class="patient-information-input">
        <p id ="patient-information-text">Room Number</p>
        <input type="number" id ="patient-input-text"  name="patientRoomNumber" placeholder="1234">
    </div>

    </div>
</form>
    </div>
    <form id ="trip-information-form" class="form-information">
        <h3 id="page-header">Trip Information</h3>  
        <div class="trip-information">
        <div class="trip-date-time-container">
        <div class="trip-information-input">
        <p id ="trip-information-text" >Date</p>
        <!-- DT stands fro Date Time-->
        <input type="date" id ="trip-input-DT" name="patientDischargeDate" >
    </div>
        <div class="trip-information-input">
        <p id ="trip-information-text" >Time</p>
        <input type="time" id ="trip-input-DT" name="patientDischargeTime" >
    </div>
    </div>
    <div class="trip-address">
    <p id ="trip-information-text" >Address</p>
        <input type="text" id="trip-address-input" name="patientDischargeAddress" placeholder="12401 Washington Blvd, Whittier, CA 90602">
    </div>
    <div class="trip-transportation-type">
        <input type="button" class="transportation-type" id ="trip-transportation-means" value="Ambulatory"><input type="button" class="transportation-type"  id="trip-transportation-means" value="Wheelchair"><input type="button" class="transportation-type"  id="trip-transportation-means" value="Gurney">
        <div class="checkbox-container">
            <label class="checkbox-label" for="oxygen">Oxygen</label>
            <input type="checkbox" id="oxygen" name="patientOxygen" value="Oxygen">
          </div>
        
          <div id ="oxygenAmount" class="checkbox-container">
            <label class="checkbox-label" for="OxygenAmount">Amount</label>
            <input type="number" id="oxygen-input" name="patientOxygenAmount" placeholder="Liter(s)">
          </div>

          <div class="checkbox-container">
            <label class="checkbox-label" for="isolation">Isolation</label>
            <input type="checkbox" id="isolation" name="patientIsolation" value="ISO">
          </div>
    </div>
        <textarea name="patientComments" rows="5" cols="85" placeholder="Enter additional information here"></textarea>
    </div>

    </form>
<div class="button-container">
    <button id="discharge-request-submission">Submit</button>
    <button id="edit-discharge-request">Save</button>
</div>

</main>
<script>
    "use strict";

    class PatientDischargeRequestor {
  constructor(name, extension, department, hospital) {
    this.name = name;
    this.extension = extension;
    this.department = department;
    this.hospital = hospital;
  }
  
}

    class Patient {
  constructor(firstName,lastName,phoneNumber,mrn, dob, height, weight, gender,primaryLanguage, roomNumber) {
    this.firstName = firstName;
    this.lastName = lastName;
    this.phoneNumber = phoneNumber;
    this.mrn = mrn;
    this.dob = dob;
    this.height = height;
    this.weight = weight;
    this.gender = gender;
    this.primaryLanguage = primaryLanguage;
    this.roomNumber = roomNumber;
  }

}

    class Trip{
        constructor(date,time, address, transportationType,oxygenNeeded,amountOfOxygen,isolation,additional_info){
            this.date = date;
            this.time = time;
            this.address = address;
            this.transportationType = transportationType;
            this.oxygenNeeded = oxygenNeeded;
            this.amountOfOxygen = amountOfOxygen;
            this.isolation = isolation;
            this.additional_info = additional_info;
        }
    }


    
    //check if we have params
    //if we have params that means user looked up patient
    //fill form with data and provide an edit button instead of submit
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.has('patient') && urlParams.has('MRN'))  {
        //get data from current session
     let data;
     let oxygen = true;
     const userData = JSON.parse(sessionStorage.getItem('selectedUserData'));
     (async () => {
        //get data from server
        console.log(userData);
     data =  await getPatientData(userData.patient_id);
     console.log(data);
        //Instantiate requestor, patient, trip 
     const requestor = new PatientDischargeRequestor(data[0].name,data[0].ext,data[0].dept,data[0].hospital);
     const patientDOB = data[0].dob.split("T"); 
     const patient = new Patient(data[0].first_name, data[0].last_name, data[0].phone_number, data[0].mrn, patientDOB[0], data[0].height, data[0].weight,data[0].gender,data[0].primary_language,data[0].room_number);
    //if oxygen needed = 0 we dont need oxygen
     if(data[0].oxygen_needed == 0){
         oxygen = false;
        }

    const trip = new Trip(data[0].date_needed,data[0].time_needed,data[0].address,data[0].transportation_type,oxygen,data[0].oxygen_needed,data[0].isolation_status,data[0].additional_info);
    
    //fill form with object information
    fillForm(requestor,patient,trip);
    
    
    let previousButton = null;
    document.querySelectorAll(".transportation-type").forEach(button => {
        
    button.addEventListener("click", (event) => {
        clearButtonColor();

        // remove the gray background from the previous button
        if (previousButton) {
            previousButton.style.backgroundColor = "";
        }

        // set the transportation type and apply gray background to the clicked button
        trip.transportationType = button.value;
        button.style.backgroundColor = "gray";

        // update the previous button reference
        previousButton = button;
    });
});
const oxygenStatus = document.getElementById("oxygen");
    //when checkbox is clicked we append an input field to acquire the 
    // amount of oxygen that is needed 
    oxygenStatus.addEventListener("change",() =>
        {
            let oxygenInputAmount = document.getElementById('oxygenAmount');
            // if checkbox is selected we change the dispaly to reveal the input field
            if(oxygenStatus.checked){
                oxygenInputAmount.style.display = 'flex';
            }// if checkbox is not selected we hide the input field 
            else{
                oxygenInputAmount.style.display = 'none';
            }
        }
    )
    //handle when save button is clicked 
    document.getElementById("edit-discharge-request").addEventListener("click", (e) => {
        let {formRequestor,formPatient,formTrip} =  getFormValues(trip.transportationType, oxygenStatus);
        console.log(trip.transportationType)
    postEditDischargeForm(data[0].req_id,userData.patient_id,formRequestor,formPatient,formTrip);
   })

     
     })();



     //hide submit button and present save button 
     document.getElementById('discharge-request-submission').style.display = 'none';
     document.getElementById('edit-discharge-request').style.display = 'block';

   
}
// if no params in url that means user is filling in new form 
    else {
        const oxygenStatus = document.getElementById("oxygen");
    //when checkbox is clicked we append an input field to acquire the 
    // amount of oxygen that is needed 
    oxygenStatus.addEventListener("change",() =>
        {
            let oxygenInputAmount = document.getElementById('oxygenAmount');
            // if checkbox is selected we change the dispaly to reveal the input field
            if(oxygenStatus.checked){
                oxygenInputAmount.style.display = 'flex';
            }// if checkbox is not selected we hide the input field 
            else{
                oxygenInputAmount.style.display = 'none';
            }
        }
    )
    let transportationType = '';
    let previousButton = null;


document.querySelectorAll(".transportation-type").forEach(button => {
    button.addEventListener("click", (event) => {
        // remove the gray background from the previous button
        if (previousButton) {
            previousButton.style.backgroundColor = "";
        }

        // set the transportation type and apply gray background to the clicked button
        transportationType = button.value;
        button.style.backgroundColor = "gray";

        // update the previous button reference
        previousButton = button;
    });
});

    document.getElementById("discharge-request-submission").addEventListener("click", (event) => {
      event.preventDefault(); 
     let {formRequestor,formPatient,formTrip} =  getFormValues(transportationType,oxygenStatus);
        // send information to backend 
      postDischargeRequest(formRequestor,formPatient,formTrip); });

    }
    // function to post discharge request to backend
    async function postDischargeRequest(PatientDischargeRequestor,Patient,Trip){
        const url = 'http://localhost:3000/discharges';
        const postData = {
           PatientDischargeRequestor:PatientDischargeRequestor,
           Patient:Patient,
           Trip:Trip
        };
        try{
            let response = await fetch(url,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData),
            });

            if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                   let data = await response.text();
                    showResponseBanner(data);
        }catch(error){
            showResponseBanner(error);
        }

    }

    //get data from backend
    async function getPatientData(patient_id){
        const response = await fetch(`/patients?patient_id=${patient_id}`);
        if(response.ok){
        let data = await response.json();
        data = data.results.rows;
        return data;
        }
        else{
            console.log("Error");
        }
        
    }
    
      // function to post the edits to the form to backend
      async function postEditDischargeForm(Req_ID,Patient_ID,PatientDischargeRequestor,Patient,Trip){
        const url = 'http://localhost:3000/edit-discharges';
        const postData = {
            Req_ID:Req_ID,
            Patient_ID:Patient_ID,
           PatientDischargeRequestor:PatientDischargeRequestor,
           Patient:Patient,
           Trip:Trip
        };
        try{
            let response = await fetch(url,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData),
            });
            if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                        }
            
                        let data = await response.text();
                        showResponseBanner(data);
        }catch(error){
           showResponseBanner(error);
        }

    }
    function fillForm(requestor, patient, trip) {
    // fill out Requestor Information
    document.querySelector("input[name='dischargeRequestedBy']").value = requestor.name;
    document.querySelector("input[name='dischargeExtensionNumber']").value = requestor.extension;
    document.querySelector("input[name='dischargeDeparment']").value = requestor.department;
    document.querySelector(`input[name='dischargeHospital'][value='${requestor.hospital}']`).checked = true;

    // fill out Patient Information
    document.querySelector("input[name='patientFirstName']").value = patient.firstName;
    document.querySelector("input[name='patientLastName']").value = patient.lastName;
    document.querySelector("input[name='patientPhoneNumber']").value = patient.phoneNumber;
    document.querySelector("input[name='patientMRN']").value = patient.mrn;
    document.querySelector("input[name='patientDoB']").value = patient.dob;
    document.querySelector("input[name='patientHeight']").value = patient.height;
    document.querySelector("input[name='patientWeight']").value = patient.weight;
    document.querySelector("input[name='patientGender']").value = patient.gender;
    document.querySelector("input[name='patientLanguage']").value = patient.primaryLanguage;
    document.querySelector("input[name='patientRoomNumber']").value = patient.roomNumber;

    // fill out Trip Information
    document.querySelector("input[name='patientDischargeDate']").value = trip.date;
    document.querySelector("input[name='patientDischargeTime']").value = trip.time;
    document.querySelector("input[name='patientDischargeAddress']").value = trip.address;
    
    // set transportation type buttons
    document.querySelectorAll(".transportation-type").forEach(button => {
        if (button.value === trip.transportationType) {
            button.classList.add("selected");
            button.style.backgroundColor = "gray";
        } else {
            button.classList.remove("selected");
        }
    });

    // set Oxygen Needed checkbox
    document.querySelector("input[name='patientOxygen']").checked = trip.oxygenNeeded;
    if (trip.oxygenNeeded) {
        let oxygenInputAmount = document.getElementById('oxygenAmount');
        
        oxygenInputAmount.style.display = 'flex';
          
        document.querySelector("input[name='patientOxygenAmount']").value = trip.amountOfOxygen;
    }

    // set Isolation checkbox
    document.querySelector("input[name='patientIsolation']").checked = trip.isolation;
    
    // set additional information
    document.querySelector("textarea[name='patientComments']").value = trip.additional_info;
}


function clearButtonColor(){
    document.querySelectorAll(".transportation-type").forEach(button => {
        button.style.backgroundColor = "";
    })
}
   
//we pass in transporatatiotnType/oxygenStatus b/c we are tracking which button is pressed so the value changes dynamically 
function getFormValues(transportationType,oxygenStatus) {
    

  let name = document.querySelector("input[name='dischargeRequestedBy']").value;
  let extension = document.getElementsByName("dischargeExtensionNumber")[0].value;
  let department = document.getElementsByName("dischargeDeparment")[0].value;
  let hospital = document.querySelector('[name="dischargeHospital"]:checked').value;

  const formRequestor = new PatientDischargeRequestor(name, extension, department, hospital);

  let firstName = document.getElementsByName("patientFirstName")[0].value;
  let lastName = document.getElementsByName("patientLastName")[0].value;
  let phoneNumber = document.getElementsByName("patientPhoneNumber")[0].value;
  let mrn = document.getElementsByName("patientMRN")[0].value;
  let dob = document.getElementsByName("patientDoB")[0].value;
  let height = document.getElementsByName("patientHeight")[0].value;
  let weight = document.getElementsByName("patientWeight")[0].value;
  let gender = document.getElementsByName("patientGender")[0].value;
  let primaryLanguage = document.getElementsByName("patientLanguage")[0].value;
  let roomNumber = document.getElementsByName("patientRoomNumber")[0].value;
  
  const formPatient = new Patient(firstName, lastName, phoneNumber, mrn, dob, height, weight, gender, primaryLanguage, roomNumber);

  let date = document.getElementsByName("patientDischargeDate")[0].value;
  let time = document.getElementsByName("patientDischargeTime")[0].value;
  let address = document.getElementsByName("patientDischargeAddress")[0].value;
  let oxygen = oxygenStatus.checked;
  let isolation = document.getElementById("isolation").checked;
  let amountOfOxygen = oxygen ? document.getElementsByName("patientOxygenAmount")[0].value : 0;
  if (transportationType == '') {
    transportationType = "None";
  }

  
  let additional_info = document.getElementsByName("patientComments")[0].value;
  
  const formTrip = new Trip(date, time, address, transportationType, oxygen, amountOfOxygen, isolation, additional_info);

  return { formRequestor, formPatient, formTrip };  // Return the objects
}

//Show response when updating or adding patient
function showResponseBanner(message) {
    const banner = document.getElementById('message-banner');
    banner.textContent = message;
    //if message includes error give red banner
    banner.style.backgroundColor = String(message).includes("Error") ? "red":  "#4CAF50";

    banner.classList.add('show');  
// #4CAF50
    setTimeout(() => {
        banner.classList.remove('show');  
    }, 2000);
}
    

</script>
</body>
</html>